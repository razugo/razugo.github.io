---
title: PokerTracker - Session
nav_id: session
---

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>{{ page.title | default: "PokerTracker" }}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slim-select@2/dist/slimselect.min.css">
  <link rel="stylesheet" href="{{ '/projects/poker_tracker/assets/styles/main.css' | relative_url }}">
  <link rel="stylesheet" href="{{ '/projects/poker_tracker/assets/styles/nav-bar.css' | relative_url }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="nav-container" data-component="nav-bar" data-active="{{ page.nav_id | default: '' }}" data-base="{{ '/projects/poker_tracker' | relative_url }}">
  <nav class="nav">
    <a href="{{ '/projects/poker_tracker/' | relative_url }}" class="nav-brand">PokerTracker</a>
    <ul class="nav-menu">
      <li><a href="#" class="nav-link live-session-btn">Live Session</a></li>
      <li><a href="{{ '/projects/poker_tracker/' | relative_url }}" class="nav-link{% if page.nav_id == 'dashboard' %} active{% endif %}" data-nav-id="dashboard">Dashboard</a></li>
      <li><a href="{{ '/projects/poker_tracker/bankroll/' | relative_url }}" class="nav-link{% if page.nav_id == 'bankroll' %} active{% endif %}" data-nav-id="bankroll">Bankroll</a></li>
      <li><a href="{{ '/projects/poker_tracker/sessions/' | relative_url }}" class="nav-link{% if page.nav_id == 'sessions' %} active{% endif %}" data-nav-id="sessions">Sessions</a></li>
      <li><a href="{{ '/projects/poker_tracker/tools/' | relative_url }}" class="nav-link{% if page.nav_id == 'tools' %} active{% endif %}" data-nav-id="tools">Tools</a></li>
    </ul>
    <button class="nav-toggle" aria-label="Toggle navigation">‚ò∞</button>
  </nav>
</div>

  <main>
    <!-- Live Stats Bar (always visible) -->
<div class="live-stats-bar" id="liveStatsBar">
  <div class="live-stats-inner">
    <div class="live-stats-content">
      <div class="stat-group stat-session">
        <span class="stat-label">Session</span>
        <span class="stat-value session-name" id="sessionNameStat">Session Details</span>
      </div>
      <div class="stat-group">
        <span class="stat-label">VPIP</span>
        <span class="stat-value" id="vpipStat">0% (0/0)</span>
      </div>
      <div class="stat-group">
        <span class="stat-label">P&L</span>
        <span class="stat-value" id="profitStat">$0</span>
      </div>
    </div>
    <button class="live-stats-toggle" type="button" onclick="showSessionSettingsModal()" aria-label="Session settings">
      <svg class="live-stats-toggle-icon" viewBox="0 0 24 25" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M11.999 8.774C9.881 8.774 8.164 10.491 8.164 12.609C8.164 14.727 9.881 16.444 11.999 16.444C14.117 16.444 15.834 14.727 15.834 12.609C15.834 10.491 14.117 8.774 11.999 8.774ZM9.664 12.609C9.664 11.32 10.709 10.274 11.999 10.274C13.289 10.274 14.334 11.32 14.334 12.609C14.334 13.899 13.289 14.944 11.999 14.944C10.71 14.944 9.664 13.899 9.664 12.609Z" />
      <path fill-rule="evenodd" clip-rule="evenodd" d="M2.581 8.922C1.964 9.991 2.33 11.357 3.399 11.974C3.888 12.256 3.888 12.962 3.399 13.245C2.33 13.862 1.964 15.228 2.581 16.296L4.097 18.922C4.714 19.991 6.08 20.357 7.149 19.74C7.638 19.457 8.25 19.811 8.25 20.375C8.25 21.609 9.25 22.609 10.484 22.609H13.517C14.75 22.609 15.75 21.609 15.75 20.376C15.75 19.811 16.362 19.458 16.85 19.74C17.919 20.357 19.284 19.991 19.901 18.923L21.418 16.296C22.034 15.228 21.668 13.862 20.6 13.245C20.111 12.962 20.111 12.256 20.6 11.974C21.668 11.357 22.034 9.991 21.418 8.922L19.901 6.296C19.285 5.228 17.919 4.862 16.85 5.479C16.362 5.761 15.75 5.408 15.75 4.843C15.75 3.61 14.75 2.609 13.517 2.609H10.484C9.25 2.609 8.25 3.61 8.25 4.843C8.25 5.408 7.638 5.762 7.149 5.479C6.08 4.862 4.714 5.228 4.097 6.297L2.581 8.922ZM4.149 10.675C3.798 10.472 3.677 10.023 3.88 9.672L5.396 7.047C5.599 6.696 6.048 6.575 6.399 6.778C7.888 7.638 9.75 6.563 9.75 4.843C9.75 4.438 10.079 4.109 10.484 4.109H13.517C13.922 4.109 14.25 4.438 14.25 4.843C14.25 6.562 16.111 7.637 17.6 6.778C17.951 6.575 18.4 6.695 18.602 7.046L20.119 9.672C20.321 10.023 20.201 10.472 19.85 10.675C18.361 11.535 18.361 13.684 19.85 14.544C20.201 14.747 20.321 15.195 20.119 15.546L18.602 18.173C18.4 18.523 17.951 18.644 17.6 18.441C16.111 17.582 14.25 18.657 14.25 20.376C14.25 20.781 13.922 21.109 13.517 21.109H10.484C10.079 21.109 9.75 20.781 9.75 20.375C9.75 18.656 7.888 17.581 6.399 18.441C6.048 18.644 5.599 18.523 5.396 18.172L3.88 15.546C3.677 15.195 3.798 14.747 4.149 14.544C5.638 13.684 5.638 11.535 4.149 10.675Z" />
    </svg>
    </button>
  </div>
</div>


<!-- Main Content with View Tabs -->
<div class="container session-body" style="padding-top: 1.5rem;">
  <div class="session-body-inner">
  <!-- View Tabs -->
  <div id="view-tabs">
    <button id="grid-tab" class="view-tab active">Grid</button>
    <button id="list-tab" class="view-tab">List</button>
  </div>

  <!-- Grid Container -->
  <div id="grid-container">
    <div id="grid" aria-label="13 by 13 poker starting-hand grid"></div>

    <div id="toggle-controls">
      <label class="toggle-container">
        <input type="checkbox" id="toggleCounts" class="toggle-input">
        <span class="toggle-slider"></span>
        <span class="toggle-label">Counts</span>
      </label>
      <label class="toggle-container">
        <input type="checkbox" id="togglePlayed" class="toggle-input">
        <span class="toggle-slider"></span>
        <span class="toggle-label">Played</span>
      </label>
      <button id="undo">Undo</button>
    </div>

    <div class="note">Quick tap: dealt (folded). Long press (>600ms): dealt AND played.</div>

    <!-- Hand Analysis -->
    <div class="card session-analysis-card" id="sessionAnalysisCard">
      <div class="card-header">
        <div>
          <h2 class="card-title">Hand Analysis</h2>
          <p class="card-subtitle">Compare your dealt hands against expected variance.</p>
        </div>
        <div class="session-analysis-mode" id="handAnalysisMode">Analyzing all dealt hands</div>
      </div>
      <div class="card-content">
        <div class="session-analysis-empty" id="handAnalysisEmpty">Track some hands in this session to unlock hand analysis.</div>
        <div class="session-analysis-body is-hidden" id="handAnalysisBody">
          <div class="session-analysis-chart">
            <canvas id="handAnalysisChart"></canvas>
          </div>
          <div class="session-analysis-stats">
            <div class="analysis-stat-card">
              <span class="analysis-stat-label">Result</span>
              <span class="analysis-stat-value" id="handAnalysisBadge">Expected üìä</span>
            </div>
            <div class="analysis-stat-card">
              <span class="analysis-stat-label">Avg Strength</span>
              <span class="analysis-stat-value" id="handAnalysisAvg">-</span>
            </div>
            <div class="analysis-stat-card">
              <span class="analysis-stat-label">Z-Score</span>
              <span class="analysis-stat-value" id="handAnalysisZScore">-</span>
            </div>
            <div class="analysis-stat-card">
              <span class="analysis-stat-label">Std Dev</span>
              <span class="analysis-stat-value" id="handAnalysisStd">-</span>
            </div>
          </div>
          <div class="session-analysis-footer">
            <p class="analysis-sample" id="handAnalysisSample"></p>
            <p class="analysis-description" id="handAnalysisDescription"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- List Container -->
  <div id="list-container">
    <!-- List items will be dynamically generated -->
  </div>
</div>
</div>

<!-- Magnify overlay for mobile -->
<div id="magnify-overlay"></div>

<script src="{{ '/projects/poker_tracker/assets/js/constants.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/hand-analysis.js' | relative_url }}"></script>
<script>

  let currentSessionId = null;
  let currentView = 'grid';
  let showCounts = false;
  let showPlayed = false;

  function syncToggleState() {
    const countsToggle = document.getElementById('toggleCounts');
    const playedToggle = document.getElementById('togglePlayed');
    if (countsToggle) countsToggle.checked = showCounts;
    if (playedToggle) playedToggle.checked = showPlayed;
  }

  // Interaction state
  let activeCell = null;
  let isMouseDown = false;
  let longPressTimer = null;

  // Elements
  const grid = document.getElementById('grid');
  const gridTab = document.getElementById('grid-tab');
  const listTab = document.getElementById('list-tab');
  const gridContainer = document.getElementById('grid-container');
  const listContainer = document.getElementById('list-container');
  const magnifyOverlay = document.getElementById('magnify-overlay');
  const analysisElements = {
    card: document.getElementById('sessionAnalysisCard'),
    empty: document.getElementById('handAnalysisEmpty'),
    body: document.getElementById('handAnalysisBody'),
    badge: document.getElementById('handAnalysisBadge'),
    mode: document.getElementById('handAnalysisMode'),
    avg: document.getElementById('handAnalysisAvg'),
    zScore: document.getElementById('handAnalysisZScore'),
    stdDev: document.getElementById('handAnalysisStd'),
    sample: document.getElementById('handAnalysisSample'),
    description: document.getElementById('handAnalysisDescription'),
    chartCanvas: document.getElementById('handAnalysisChart')
  };

  // Get session ID from URL parameters
  function getSessionIdFromURL() {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('session_id');
  }

  function toggleSessionOverlay() {
    document.getElementById('sessionOverlay').classList.toggle('expanded');
  }

  function getCurrentSession() {
    if (!currentSessionId) return null;
    return PokerTracker.DataStore.getSession(currentSessionId);
  }

  function getSessionData() {
    if (!currentSessionId) {
      console.error('getSessionData: No currentSessionId');
      return null;
    }
    const data = PokerTracker.DataStore.getSessionData(currentSessionId);
    console.log('getSessionData result:', data);
    return data;
  }

  function updateSessionStats() {
    if (!currentSessionId) {
      console.error('updateSessionStats: No currentSessionId');
      return;
    }

    console.log('updateSessionStats: Getting session data for ID:', currentSessionId);
    const sessionData = getSessionData();

    if (!sessionData) {
      console.error('updateSessionStats: No session data returned');
      return;
    }
    const session = getCurrentSession();

    if (!session || !sessionData) return;

    const vpipPercent = sessionData.vpip.toFixed(1);
    const profit = (session.cashOut || 0) - (session.buyIn || 0);

    // Update live stats bar
    const sessionDate = PokerTracker.DataStore.getSessionDate(session) || 'Current Session';
    document.getElementById('sessionNameStat').textContent = sessionDate || 'Session Details';

    document.getElementById('vpipStat').textContent = `${vpipPercent}% (${sessionData.totalPlayed}/${sessionData.total})`;

    const profitElement = document.getElementById('profitStat');
    profitElement.textContent = `${profit >= 0 ? '+' : ''}${PokerTracker.Utils.formatCurrency(profit)}`;
    profitElement.className = 'stat-value ' + (profit >= 0 ? 'positive' : 'negative');



  }

  function updateHandAnalysisView(sessionData) {
    if (!analysisElements.card || !window.PokerTracker || !PokerTracker.HandAnalysis) {
      return;
    }

    const modeText = showPlayed ? 'Analyzing played hands' : 'Analyzing all dealt hands';
    if (analysisElements.mode) {
      analysisElements.mode.textContent = modeText;
    }

    const data = sessionData || getSessionData();
    if (!currentSessionId || !data || !Array.isArray(data.handHistory)) {
      PokerTracker.HandAnalysis.clear(analysisElements, 'Select a session to view hand analysis.');
      return;
    }

    PokerTracker.HandAnalysis.update({
      handHistory: data.handHistory,
      usePlayedOnly: showPlayed,
      elements: analysisElements
    });
  }

  function keyFor(i, j) {
    const ranks = ['A','K','Q','J','T','9','8','7','6','5','4','3','2'];
    if (i === j) {
      return ranks[i] + ranks[i];
    } else if (i < j) {
      return ranks[i] + ranks[j] + 's';
    } else {
      return ranks[j] + ranks[i] + 'o';
    }
  }

  function buildGrid() {
    grid.innerHTML = '';
    for (let i = 0; i < 13; i++) {
      for (let j = 0; j < 13; j++) {
        const key = keyFor(i, j);
        const cell = document.createElement('button');
        cell.type = 'button';
        cell.className = 'cell' + (i === j ? ' pair' : '');
        cell.dataset.key = key;
        cell.textContent = key;
        grid.appendChild(cell);
      }
    }
    render();
    fitGridToViewport();
  }

  function updateCellColors() {
    const sessionData = getSessionData();
    if (!sessionData) return;

    const cells = grid.children;
    const sourceData = showPlayed ? sessionData.playedCounts : sessionData.counts;
    const values = Object.values(sourceData);
    const max = Math.max(1, ...values);

    for (const cell of cells) {
      const key = cell.dataset.key;
      const c = sourceData[key] || 0;

      let baseColor;
      if (key.endsWith('s')) { // Suited
        baseColor = '#D8D8D8';
      } else if (key.length === 2) { // Pair
        baseColor = '#A9A9A9';
      } else { // Off-suit
        baseColor = '#FFFFFF';
      }

      if (c > 0) {
        const ratio = c / max;
        const r = 255;
        const g = Math.round(255 * (1 - ratio));
        const b = Math.round(255 * (1 - ratio));
        cell.style.backgroundColor = `rgb(${r},${g},${b})`;
        const luminance = 0.2126*r + 0.7152*g + 0.0722*b;
        cell.style.color = luminance < 128 ? '#ffffff' : '#2d3748';
      } else {
        cell.style.backgroundColor = baseColor;
        cell.style.color = '#2d3748';
      }
    }
  }

  function render() {
    const sessionData = getSessionData();
    if (!sessionData) {
      // Clear grid when no session selected
      for (const cell of grid.children) {
        const key = cell.dataset.key;
        cell.textContent = key;
        cell.classList.remove('played');
        cell.style.backgroundColor = '';
        cell.style.color = '';
      }
      if (window.PokerTracker && PokerTracker.HandAnalysis) {
        PokerTracker.HandAnalysis.clear(analysisElements, 'Select a session to view hand analysis.');
      }
      if (analysisElements.mode) {
        analysisElements.mode.textContent = showPlayed ? 'Analyzing played hands' : 'Analyzing all dealt hands';
      }
      return;
    }

    for (const cell of grid.children) {
      const key = cell.dataset.key;
      const playedCount = sessionData.playedCounts[key] || 0;
      const totalCount = sessionData.counts[key] || 0;

      if (showCounts) {
        cell.textContent = showPlayed ? playedCount : totalCount;
      } else {
        cell.textContent = key;
      }

      cell.classList.toggle('played', playedCount > 0);
      cell.style.display = 'flex';
    }
    updateCellColors();
    updateHandAnalysisView(sessionData);
  }

  function updateMagnifyOverlay(cell, clientX, clientY) {
    const currentBg = magnifyOverlay.style.backgroundColor;

    magnifyOverlay.textContent = cell.textContent;

    const newClasses = ['cell'];
    if (cell.classList.contains('pair')) {
      newClasses.push('pair');
    }
    magnifyOverlay.className = newClasses.join(' ');
    magnifyOverlay.id = 'magnify-overlay';

    if (currentBg === '#e8f5e8' || currentBg === 'rgb(232, 245, 232)') {
      magnifyOverlay.style.backgroundColor = '#e8f5e8';
    } else {
      magnifyOverlay.style.backgroundColor = cell.style.backgroundColor || '';
    }
    magnifyOverlay.style.color = cell.style.color || '';

    if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
      const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'));
      const scaledSize = cellSize * 2.0;
      magnifyOverlay.style.left = (clientX - scaledSize / 2) + 'px';
      magnifyOverlay.style.top = (clientY - 40) + 'px';
    }
  }

  function showMagnifyOverlay(cell, clientX, clientY) {
    if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
      magnifyOverlay.style.display = 'flex';
      magnifyOverlay.style.backgroundColor = '';
      updateMagnifyOverlay(cell, clientX, clientY);
    }
  }

  function hideMagnifyOverlay() {
    magnifyOverlay.style.display = 'none';
  }

  function increment(key, played = false) {
    if (!currentSessionId) return;

    const sessionData = getSessionData();
    if (!sessionData) return;

    const handEntry = {
      id: Date.now().toString(),
      key: key,
      timestamp: Date.now(),
      played: played,
      position: sessionData.handHistory.length + 1,
      notes: ""
    };

    // Add to session data
    PokerTracker.DataStore.addHand(currentSessionId, key, played, handEntry.notes);

    updateSessionStats();
    render();

    if (currentView === 'list') {
      renderList();
    }
  }

  function renderList() {
    const sessionData = getSessionData();
    listContainer.innerHTML = '';

    if (!sessionData) return;

    const sortedHands = [...sessionData.handHistory].reverse();

    sortedHands.forEach((hand, index) => {
      const handIndex = sessionData.handHistory.length - 1 - index;
      const listItem = document.createElement('div');
      listItem.className = 'list-item';
      listItem.dataset.handIndex = handIndex;

      listItem.innerHTML = `
        <div class="list-item-hand">${hand.key}</div>
        <div class="list-item-position">#${hand.position}</div>
        <div class="list-item-actions">
          <button class="action-button notes-button" data-action="notes">Notes</button>
          <button class="toggle-switch ${hand.played ? 'played' : ''}" data-action="toggle"></button>
          <button class="delete-button" data-action="delete">üóëÔ∏è</button>
        </div>
        <div class="list-item-notes-container ${hand.notes ? 'active' : ''}">
          <textarea class="list-item-notes" placeholder="Add notes...">${hand.notes || ''}</textarea>
        </div>
      `;

      const notesButton = listItem.querySelector('[data-action="notes"]');
      const notesContainer = listItem.querySelector('.list-item-notes-container');
      const toggleButton = listItem.querySelector('[data-action="toggle"]');
      const deleteButton = listItem.querySelector('[data-action="delete"]');
      const notesTextarea = listItem.querySelector('.list-item-notes');

      if (hand.notes && hand.notes.trim() !== '') {
        notesButton.classList.add('toggle-active');
      }

      notesButton.addEventListener('click', () => {
        notesContainer.classList.toggle('active');
        notesButton.classList.toggle('toggle-active');
      });

      toggleButton.addEventListener('click', () => {
        toggleHandStatus(handIndex);
      });

      deleteButton.addEventListener('click', () => {
        deleteHand(handIndex);
      });

      notesTextarea.addEventListener('input', () => {
        saveNotes(handIndex, notesTextarea.value);
      });

      listContainer.appendChild(listItem);
    });
  }

  function handleInteractionStart(e) {
    if (!getCurrentSession()) return;

    if (e.target.classList.contains('cell')) {
      isMouseDown = true;
      if (activeCell) {
        activeCell.classList.remove('active', 'playing');
      }
      activeCell = e.target;
      activeCell.classList.add('active');

      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      showMagnifyOverlay(activeCell, clientX, clientY);

      longPressTimer = setTimeout(() => {
        if (isMouseDown && activeCell) {
          activeCell.classList.add('playing');
          magnifyOverlay.style.backgroundColor = '#e8f5e8';
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
        }
      }, 600);

      e.preventDefault();
    }
  }

  function handleInteractionMove(e) {
    if (isMouseDown) {
      let clientX, clientY;
      if (e.touches) {
        clientX = e.touches[0].clientX;
        clientY = e.touches[0].clientY;
      } else {
        clientX = e.clientX;
        clientY = e.clientY;
      }

      if (window.matchMedia('(hover: none) and (pointer: coarse)').matches) {
        const cellSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell'));
        const scaledSize = cellSize * 2.0;
        magnifyOverlay.style.left = (clientX - scaledSize / 2) + 'px';
        magnifyOverlay.style.top = (clientY - 40) + 'px';
      }

      const target = document.elementFromPoint(clientX, clientY);

      if (target && target.classList.contains('cell') && target !== activeCell) {
        clearTimeout(longPressTimer);

        if (activeCell) {
          activeCell.classList.remove('active', 'playing');
        }

        magnifyOverlay.style.backgroundColor = '';

        activeCell = target;
        activeCell.classList.add('active');

        updateMagnifyOverlay(activeCell, clientX, clientY);

        longPressTimer = setTimeout(() => {
          if (isMouseDown && activeCell) {
            activeCell.classList.add('playing');
            magnifyOverlay.style.backgroundColor = '#e8f5e8';
            if (navigator.vibrate) {
              navigator.vibrate(50);
            }
          }
        }, 600);
      }
      e.preventDefault();
    }
  }

  function handleInteractionEnd(e) {
    if (isMouseDown && activeCell) {
      let releaseTarget;
      if (e.touches && e.changedTouches && e.changedTouches.length > 0) {
        releaseTarget = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
      } else {
        releaseTarget = e.target;
      }

      const gridContainer = document.getElementById('grid');
      const isOverGrid = releaseTarget && (releaseTarget.classList.contains('cell') || gridContainer.contains(releaseTarget));

      if (isOverGrid) {
        const key = activeCell.dataset.key;
        const wasLongPress = activeCell.classList.contains('playing');

        clearTimeout(longPressTimer);
        increment(key, wasLongPress);
      } else {
        clearTimeout(longPressTimer);
      }

      activeCell.classList.remove('active', 'playing');
      activeCell = null;
    }

    hideMagnifyOverlay();
    isMouseDown = false;
    clearTimeout(longPressTimer);
  }

  function saveNotes(handIndex, notes) {
    const sessionData = getSessionData();
    if (!sessionData) return;

    const hand = sessionData.handHistory[handIndex];
    if (hand) {
      PokerTracker.DataStore.updateHandNotes(currentSessionId, hand.id, notes);
    }
  }

  function toggleHandStatus(handIndex) {
    const sessionData = getSessionData();
    if (!sessionData) return;

    const hand = sessionData.handHistory[handIndex];
    if (hand) {
      PokerTracker.DataStore.updateHandStatus(currentSessionId, hand.id, !hand.played);
      updateSessionStats();
      render();
      renderList();
    }
  }

  function deleteHand(handIndex) {
    const sessionData = getSessionData();
    if (!sessionData) return;

    const hand = sessionData.handHistory[handIndex];
    if (hand && confirm('Delete this hand?')) {
      PokerTracker.DataStore.deleteHand(currentSessionId, hand.id);
      updateSessionStats();
      render();
      renderList();
    }
  }

  function undo() {
    PokerTracker.DataStore.undoLastHand(currentSessionId);
    updateSessionStats();
    render();
    if (currentView === 'list') {
      renderList();
    }
  }

  function toggleCounts() {
    const checkbox = document.getElementById('toggleCounts');
    showCounts = checkbox.checked;
    render();
  }

  function togglePlayedFilter() {
    const checkbox = document.getElementById('togglePlayed');
    showPlayed = checkbox.checked;
    render();
  }

  function switchView(view) {
    currentView = view;

    // Hide all containers
    gridContainer.style.display = 'none';
    listContainer.classList.remove('active');

    // Remove active class from all tabs
    gridTab.classList.remove('active');
    listTab.classList.remove('active');

    // Show selected view
    if (view === 'grid') {
      gridContainer.style.display = 'flex';
      gridTab.classList.add('active');
    } else if (view === 'list') {
      listContainer.classList.add('active');
      listTab.classList.add('active');
      renderList();
    }
  }

  function fitGridToViewport() {
    const root = document.documentElement;
    const vw = document.documentElement.clientWidth;

    let chosenGap;
    if (vw < 768) chosenGap = 2;
    else chosenGap = 4;

    root.style.setProperty('--gap', chosenGap + 'px');

    let containerPadding, bodyPadding;
    if (vw < 480) {
      containerPadding = 24;
      bodyPadding = 0;
    } else {
      containerPadding = 40;
      bodyPadding = 40;
    }

    const gridWidth = vw - containerPadding - bodyPadding;
    const MAX_CELL = vw < 480 ? 30 : 56;
    const MIN_CELL = 18;
    const ideal = Math.floor((gridWidth - chosenGap * 12) / 13);
    const cell = Math.max(MIN_CELL, Math.min(MAX_CELL, ideal));
    root.style.setProperty('--cell', cell + 'px');
  }

  // Event Listeners and Initialization
  document.addEventListener('DOMContentLoaded', function() {
    currentSessionId = getSessionIdFromURL();
    console.log('Session ID from URL:', currentSessionId);

    if (!currentSessionId) {
      console.error('No session ID provided');
      window.location.href = '/projects/poker_tracker/sessions/';
      return;
    }

    // Debug: Check all available sessions
    const allSessions = PokerTracker.DataStore.getSessions();
    console.log('All available sessions:', allSessions);
    console.log('Looking for session ID:', currentSessionId);

    const session = getCurrentSession();
    console.log('Found session:', session);

    if (!session) {
      console.error(`Session not found for ID: ${currentSessionId}`);
      window.location.href = '/projects/poker_tracker/sessions/';
      return;
    }

    buildGrid();
    updateSessionStats();
    syncToggleState();

    // Setup interaction handlers
    grid.addEventListener('mousedown', handleInteractionStart);
    grid.addEventListener('mousemove', handleInteractionMove);
    document.addEventListener('mouseup', handleInteractionEnd);

    grid.addEventListener('touchstart', handleInteractionStart, { passive: false });
    grid.addEventListener('touchmove', handleInteractionMove, { passive: false });
    grid.addEventListener('touchend', handleInteractionEnd);

    // View tab handlers
    gridTab.addEventListener('click', () => switchView('grid'));
    listTab.addEventListener('click', () => switchView('list'));

    // Control button handlers
    document.getElementById('toggleCounts').addEventListener('change', toggleCounts);
    document.getElementById('togglePlayed').addEventListener('change', togglePlayedFilter);
    document.getElementById('undo').addEventListener('click', undo);

    // Session input handlers
    const buyInInput = document.getElementById('buyInInput');
    if (buyInInput) {
      buyInInput.addEventListener('change', function() {
        PokerTracker.DataStore.updateSession(currentSessionId, { buyIn: parseFloat(this.value) || 0 });
        updateSessionStats();
      });
    }

    const cashOutInput = document.getElementById('cashOutInput');
    if (cashOutInput) {
      cashOutInput.addEventListener('change', function() {
        PokerTracker.DataStore.updateSession(currentSessionId, { cashOut: parseFloat(this.value) || 0 });
        updateSessionStats();
      });
    }

    const sessionNotes = document.getElementById('sessionNotes');
    if (sessionNotes) {
      sessionNotes.addEventListener('change', function() {
        PokerTracker.DataStore.updateSessionNotes(currentSessionId, this.value);
      });
    }

    // Responsive events
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(fitGridToViewport, 100);
    }, { passive: true });

    window.addEventListener('orientationchange', () => {
      setTimeout(fitGridToViewport, 200);
    });

    // Initialize with grid view
    switchView('grid');
  });

  // Keep these legacy function names for compatibility
  function undoLastHand() {
    undo();
  }

  function endSession() {
    const session = getCurrentSession();
    if (!session) return;

    const activeSession = PokerTracker.DataStore.getActiveSession();
    const isLiveSession = activeSession && activeSession.id === session.id;

    if (isLiveSession) {
      if (confirm('End this live session? This will mark it as completed.')) {
        let durationHours = null;
        const state = PokerTracker.DataStore.appState || {};
        if (state.liveSessionStart) {
          const liveStart = new Date(state.liveSessionStart);
          if (!Number.isNaN(liveStart.getTime())) {
            const minutes = Math.max(0, (Date.now() - liveStart.getTime()) / (1000 * 60));
            if (minutes > 0) {
              durationHours = Math.round((minutes / 60) * 100) / 100;
            }
          }
        }

        let promptDefault = '';
        if (typeof durationHours === 'number') {
          promptDefault = durationHours.toFixed(2);
        }

        const input = prompt('Enter session duration in hours (e.g., 3.5). Leave blank to keep unset.', promptDefault);
        if (input === null) {
          return; // user cancelled
        }

        let finalDuration = null;
        if (input.trim() !== '') {
          const parsed = parseFloat(input);
          if (!Number.isFinite(parsed) || parsed < 0) {
            alert('Please enter a valid non-negative number for duration.');
            return;
          }
          finalDuration = Math.round(parsed * 100) / 100;
        }

        PokerTracker.DataStore.endActiveSession(session.id, { durationHours: finalDuration });
        updateSessionStats();

        // Update nav link globally
        if (window.updateLiveSessionNavLink) {
          window.updateLiveSessionNavLink();
        }

        window.location.href = '/projects/poker_tracker/sessions/';
      }
    } else {
      if (confirm('Return to sessions page?')) {
        window.location.href = '/projects/poker_tracker/sessions/';
      }
    }
  }

  // Session name functionality removed

</script>

<div data-component="new-session-modal"></div>
<div data-component="session-settings-modal"></div>

<!-- Shared JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/slim-select@2/dist/slimselect.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{{ '/projects/poker_tracker/assets/js/data-store.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/app.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/datetime-picker.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/nav-bar.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/new-session-modal.js' | relative_url }}"></script>
<script src="{{ '/projects/poker_tracker/assets/js/session-settings-modal.js' | relative_url }}"></script>

<script>
  function quickAction() {
    if (currentSessionId) {
      const sessionData = PokerTracker.DataStore.getSessionData(currentSessionId);
      if (sessionData.total > 0) {
        document.getElementById('viewTabs').style.display = 'flex';
        switchView(currentView === 'grid' ? 'list' : 'grid');
      }
    }
  }
</script>


  </main>
</body>
</html>
