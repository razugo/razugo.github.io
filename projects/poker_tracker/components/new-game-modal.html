<!-- New Game Modal -->
<div id="newGameModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New Game</h3>
      <button class="modal-close" onclick="PokerTracker.GameModal.closeNewGameModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-group">
        <label for="gameNameInput">Game Name *</label>
        <input type="text" id="gameNameInput" class="form-input" placeholder="e.g., Aria 1/3" required>
      </div>
      <div class="form-group">
        <label for="gameLocationInput">Location</label>
        <input type="text" id="gameLocationInput" class="form-input" placeholder="e.g., Aria Casino">
      </div>
      <div class="form-group">
        <label for="smallBlindInput">Small Blind</label>
        <input type="number" id="smallBlindInput" class="form-input" placeholder="1" step="0.01" min="0.01">
      </div>
      <div class="form-group">
        <label for="bigBlindInput">Big Blind</label>
        <input type="number" id="bigBlindInput" class="form-input" placeholder="3" step="0.01" min="0.01">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-outline" onclick="PokerTracker.GameModal.closeNewGameModal()">Cancel</button>
      <button class="btn btn-primary" onclick="PokerTracker.GameModal.createNewGame()">Create</button>
    </div>
  </div>
</div>

<script>
// Add game modal functionality to PokerTracker namespace
window.PokerTracker = window.PokerTracker || {};
PokerTracker.GameModal = {
  showNewGameModal: function() {
    const modal = document.getElementById('newGameModal');
    modal.style.display = 'flex';
  },

  closeNewGameModal: function() {
    const modal = document.getElementById('newGameModal');
    modal.style.display = 'none';

    // Reset form and clear error states
    this.clearForm();
  },

  clearForm: function() {
    const inputs = ['gameNameInput', 'gameLocationInput', 'smallBlindInput', 'bigBlindInput'];
    inputs.forEach(inputId => {
      const input = document.getElementById(inputId);
      const formGroup = input.closest('.form-group');

      input.value = '';
      input.classList.remove('error');
      formGroup.classList.remove('error');
    });
  },

  validateAndHighlight: function(inputId, value, validationFn, errorCondition) {
    const input = document.getElementById(inputId);
    const formGroup = input.closest('.form-group');

    // Clear previous error state
    input.classList.remove('error');
    formGroup.classList.remove('error');

    if (errorCondition) {
      input.classList.add('error');
      formGroup.classList.add('error');
      input.focus();
      return false;
    }
    return true;
  },

  createNewGame: function() {
    const gameName = document.getElementById('gameNameInput').value.trim();
    const location = document.getElementById('gameLocationInput').value.trim();
    const smallBlindValue = document.getElementById('smallBlindInput').value.trim();
    const bigBlindValue = document.getElementById('bigBlindInput').value.trim();

    let isValid = true;

    // Validate game name
    if (!this.validateAndHighlight('gameNameInput', gameName, null, !gameName)) {
      isValid = false;
    }

    // Validate small blind
    const smallBlindAmount = smallBlindValue ? Math.round(parseFloat(smallBlindValue) * 100) / 100 : null;
    if (!this.validateAndHighlight('smallBlindInput', smallBlindValue, null,
        smallBlindValue && (isNaN(smallBlindAmount) || smallBlindAmount <= 0))) {
      isValid = false;
    }

    // Validate big blind
    const bigBlindAmount = bigBlindValue ? Math.round(parseFloat(bigBlindValue) * 100) / 100 : null;
    const bigInvalid = bigBlindValue && (isNaN(bigBlindAmount) || bigBlindAmount <= 0);
    const blindOrderInvalid = !bigInvalid && bigBlindAmount !== null && smallBlindAmount !== null && bigBlindAmount <= smallBlindAmount;
    if (!this.validateAndHighlight('bigBlindInput', bigBlindValue, null, bigInvalid || blindOrderInvalid)) {
      isValid = false;
    }

    if (!isValid) {
      return;
    }

    // Create the game
    PokerTracker.DataStore.createGame(
      gameName,
      location || '-',
      smallBlindAmount,
      bigBlindAmount
    );

    this.closeNewGameModal();

    // Refresh the page if we're on games page
    if (window.location.pathname.includes('games')) {
      window.location.reload();
    } else {
      // Show success feedback for other pages
      // Could add a toast notification here in the future
    }
  }
};

// Close modal when clicking outside
document.addEventListener('click', function(e) {
  const modal = document.getElementById('newGameModal');
  if (e.target === modal) {
    PokerTracker.GameModal.closeNewGameModal();
  }
});

// Close modal with Escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    const modal = document.getElementById('newGameModal');
    if (modal.style.display === 'flex') {
      PokerTracker.GameModal.closeNewGameModal();
    }
  }
});

// Clear error state when user starts typing
document.addEventListener('DOMContentLoaded', function() {
  const inputs = ['gameNameInput', 'gameLocationInput', 'smallBlindInput', 'bigBlindInput'];
  inputs.forEach(inputId => {
    const input = document.getElementById(inputId);
    if (!input) return;

    input.addEventListener('input', function() {
      if (this.classList.contains('error')) {
        this.classList.remove('error');
        const formGroup = this.closest('.form-group');
        if (formGroup) {
          formGroup.classList.remove('error');
        }
      }
    });

    if (input.type === 'number' && input.step === '0.01') {
      input.addEventListener('input', function() {
        const value = this.value;
        const dotIndex = value.indexOf('.');
        if (dotIndex !== -1 && value.length - dotIndex - 1 > 2) {
          const trimmed = value.slice(0, dotIndex + 3);
          this.value = trimmed;
          try {
            const caret = trimmed.length;
            this.setSelectionRange(caret, caret);
          } catch (err) {
            // Ignore unsupported browsers for setSelectionRange on number inputs
          }
        }
      });
    }
  });
});
</script>
